<div class="grid justify-content-center">
    <p-card [style]="{'width': '25rem', 'margin-bottom': '2em'}" class="col-12 md:col-12 w-full pb-0">
        <ng-template pTemplate="header">
			<div class="header-card w-full h-4rem flex">
				<h2 class="col-6 md:col-6 align-self-center pl-4">Liquidación</h2>
				<div class="col-6 md:col-6 text-right align-self-center pr-4">
					<button
						pButton
						(click)="registerSettlement()"
						class="b-primary px-5 py-2 focus-visible-general"
						label="Crear liquidación"
					></button>
				</div>
			</div>
		</ng-template>

        <ng-template pTemplate="footer">
            <form [formGroup]="formFilterLiquidation">
                <div class="grid col-12 md:col-12">
                    <!-- BUSQUEDA DE LIQUIDACION -->
                    <div class="grid col-12 md:col-7 p-fluid justify-content-center pb-5 pt-3 px-0">
                        <span class="p-float-label p-input-icon-right w-full">
                            <i class="pi pi-search pr-3"></i>
                            <input
                                class="search w-full"
                                pInputText
                                formControlName="term" />
                            <label>¿Buscas una liquidación por cliente?</label>
                        </span>
                    </div>

                    <div class="grid col-12 md:col-10 p-fluid justify-content-center py-2 mb-2 px-0 card">
                        <!-- Empresa -->
                        <div class="custom-col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    [options]="lCompany"
                                    [autoDisplayFirst]="false"
                                    [showClear]="true"
                                    optionLabel="name"
                                    optionValue="id"
                                    formControlName="company"
                                    (onChange)="onChangeCompany($event.value)">
                                </p-dropdown>
                                <label>Empresa</label>
                            </span>
                        </div>

                        <!-- Sucursal -->
                        <div class="custom-col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    [options]="lBranchOffice"
                                    [autoDisplayFirst]="false"
                                    optionLabel="name"
                                    emptyMessage="Debe seleccionar una empresa"
                                    optionValue="id"
                                    formControlName="branch_office"
                                    [showClear]="true"
                                    (onChange)="onChangeBranchOffice($event.value)">
                                </p-dropdown>
                                <label>Sucursal</label>
                            </span>
                        </div>

                        <!-- Unidad -->
                        <div class="custom-col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    [options]="lUnit"
                                    [autoDisplayFirst]="false"
                                    optionLabel="name"
                                    emptyMessage="Debe seleccionar una sucursal"
                                    optionValue="id"
                                    formControlName="business_unit"
                                    [showClear]="true"
                                    (onChange)="onChangeBusinessnit($event.value)">
                                </p-dropdown>
                                <label>Unidad</label>
                            </span>
                        </div>

                        <!-- Producto  -->
                        <div class="custom-col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    [options]="lStore"
                                    [autoDisplayFirst]="false"
                                    optionLabel="name"
                                    emptyMessage="Debe seleccionar una unidad"
                                    optionValue="id"
                                    formControlName="store"
                                    [showClear]="true">
                                </p-dropdown>
                                <label>Producto</label>
                            </span>
                        </div>

                        <!-- Estado -->
                        <div class="custom-col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    [options]="lStatus"
                                    [autoDisplayFirst]="false"
                                    optionLabel="name"
                                    optionValue="id"
                                    formControlName="status"
                                    [showClear]="true">
                                </p-dropdown>
                                <label>Estado</label>
                            </span>
                        </div>

                        <!-- Moneda -->
                        <div class="custom-col-3">
                            <span class="p-float-label">
                                <p-dropdown
                                    [options]="currencyTypeList"
                                    [autoDisplayFirst]="false"
                                    optionLabel="description"
                                    optionValue="id"
                                    formControlName="type_currency"
                                    [showClear]="true">
                                </p-dropdown>
                                <label>Moneda</label>
                            </span>
                        </div>

                        <!-- LIMPIAR FILTROS -->
                        <div class="custom-col-1 justify-content-center">
                            <button
                                pButton
                                pRipple
                                icon="pi pi-trash"
                                class="p-button-rounded p-button-text text-color"
                                pTooltip="Limpiar filtros"
                                (click)="clearFilterLiquidation()"
                            ></button>
                        </div>
                    </div>
                </div>
            </form>
        </ng-template>
    </p-card>

    <ng-container *ngIf="loaderService.opened">
		<p-skeleton
			class="col-12 md:col-12"
			borderRadius="20px"
			height="30rem"
		></p-skeleton>
	</ng-container>

    <div *ngIf="!loaderService.opened" class="col-12 md:col-12 mt-0 pt-0">

        <div class="col-12 pb-4 flex flex-row pt-0">
			<h2 class="col-4 md:col-4 my-0 py-0 font-semibold text-800">Resultados</h2>
            <div class="col-4 md:col-4 text-center">
                <span class="mr-1 text-500 font-semibold ">Suma Total</span> <span class="ml-0  pr-4 font-semibold"> S/{{additional_data?.total_price_local_currency | number : "1.2-2"}}</span>
                <span class="pr-1 text-500 font-semibold">Suma Total</span> <span class="ml-0  pr-4 font-semibold"> $ {{additional_data?.total_price_foreign_currency | number : "1.2-2"}}</span>
            </div>
			<h3 class="col-4 md:col-4 my-0 py-0 text-600 flex justify-content-end align-self-center font-medium">{{ message ?? "No se encontraron resultados" }}</h3>
		</div>


        <p-table [value]="lLiquidation" class="mx-0 px-0"  styleClass="p-datatable-m" [scrollable]="true" scrollHeight="370px" [tableStyle]="{'min-width': '30rem'}">
            <ng-template pTemplate="header">
                <tr>
                    <th class="text-center">N°</th>
                    <th class="text-center">Fecha de creación</th>
                    <th class="text-center">Empresa</th>
                    <th class="text-center">Sucursal</th>
                    <th class="text-center">Unidad</th>
                    <th class="text-center">Producto</th>
                    <th class="text-center">Cliente</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Opciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-liquidation>
                <tr>
                    <td class="text-center">{{ liquidation.id }}</td>
                    <td class="text-center">{{ liquidation.creation_date | date : "dd/MM/YYYY" }}</td>
                    <td class="text-center">
                        <span [pTooltip]="liquidation.company_name">{{ liquidation.company_name === "SCHARFF LOGISTICA INTEGRADA S.A." ? "SLI" : "SICCSA" }}</span>
                    </td>
                    <td class="text-center">{{ liquidation.branch_office_name | uppercase}}</td>
                    <td class="text-center">{{ liquidation.business_unit_name | uppercase}}</td>
                    <td class="text-center">{{ liquidation.store_name | uppercase}}</td>
                    <td class="ellipsis max-w-15rem" [pTooltip]="liquidation.client_name | uppercase">{{ liquidation.client_name | uppercase}}</td>
                    <td class="text-right">
                        <span>{{ liquidation.currency_type }}</span>
                        <span>{{ liquidation.subtotal_price | number : "1.2-2" }}</span>
                    </td>
                    <td class="text-center">
                        <div class="status-component" [class]="getStatusLiquidation(liquidation.status_code)">{{liquidation.status_description | uppercase}}</div>
                    </td>
                    <td class="text-center">
                        <button
                            pButton
                            class="p-button-text"
                            (click)="menu.toggle($event); getOptionsByStatus(liquidation)"
                            icon="pi pi-ellipsis-v">
                        </button>
                        <p-menu
                            #menu
                            [model]="options"
                            [popup]="true"
                            appendTo="body">
                        </p-menu>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="col-12 md:col-6 align-items-center grid pt-0 mt-0">
        <p-dropdown
                [options]="pageSizeOptions"
                (onChange)="onPageSizeChange($event.value);
                getAllLiquidations()">
        </p-dropdown>
        <div class="pl-4">
            <span>
                Mostrando el intervalo 1 - {{pageSize}} de {{additional_data?.total_rows}} resultados.
            </span>
        </div>
    </div>

    <div class="col-12 md:col-6 pt-0 mt-0">
        <p-paginator
                [rows]="pageSize"
                [totalRecords]="additional_data?.total_rows"
                (onPageChange)="getAllLiquidations($event.page)">
        </p-paginator>
    </div>
</div>
